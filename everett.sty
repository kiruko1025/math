\ProvidesPackage{everett}

% Arguments
\newif\ifdark\darkfalse
\DeclareOption{dark}{\darktrue}
\ProcessOptions\relax

% Packages
\usepackage{lmodern}
\usepackage[pdfusetitle]{hyperref}
\ExplSyntaxOn
\sys_if_engine_luatex:T {
	\usepackage{luatex85}
}
\sys_if_engine_pdftex:T {
	\usepackage[T1]{fontenc}
}
\ExplSyntaxOff

\usepackage{amsmath, amsfonts, mathtools, amsthm, amssymb}
\usepackage{textcomp}
\usepackage{import}
\usepackage{xifthen}
\usepackage{pdfpages}
\usepackage{transparent}
\usepackage{listings}
\usepackage{graphicx}
\usepackage{xcolor}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{geometry}
\usepackage{setspace}
\usepackage{mathrsfs}
\usepackage[usenames,svgnames,dvipsnames]{xcolor}
\usepackage{textcomp}
\usepackage{enumerate}
\usepackage[textsize=scriptsize,shadow]{todonotes}
\usepackage{microtype}
\usepackage[normalem]{ulem}
\usepackage{stmaryrd}
\usepackage{wasysym}
\usepackage{multirow}
\usepackage{prerex}
\usepackage[nameinlink]{cleveref}
\usepackage{derivative}
\usepackage{url}
\usepackage{float}
\usepackage{booktabs}
\usepackage{enumitem}
\usepackage{emptypage}
\usepackage{subcaption}
\usepackage{multicol}
\usepackage[usenames,dvipsnames]{xcolor}
\usepackage{mathrsfs}
\usepackage{cancel}
\usepackage{bm}
\usepackage{systeme}

% Color Palette
\ifdark
  % -------- Mocha (dark) --------
  \definecolor{ctpRosewater}{HTML}{F5E0DC}
  \definecolor{ctpFlamingo}{HTML}{F2CDCD}
  \definecolor{ctpPink}{HTML}{F5C2E7}
  \definecolor{ctpMauve}{HTML}{CBA6F7}
  \definecolor{ctpRed}{HTML}{F38BA8}
  \definecolor{ctpMaroon}{HTML}{EBA0AC}
  \definecolor{ctpPeach}{HTML}{FAB387}
  \definecolor{ctpYellow}{HTML}{F9E2AF}
  \definecolor{ctpGreen}{HTML}{A6E3A1}
  \definecolor{ctpTeal}{HTML}{94E2D5}
  \definecolor{ctpSky}{HTML}{89DCEB}
  \definecolor{ctpSapphire}{HTML}{74C7EC}
  \definecolor{ctpBlue}{HTML}{89B4FA}
  \definecolor{ctpLavender}{HTML}{B4BEFE}
  \definecolor{ctpText}{HTML}{CDD6F4}
  \definecolor{ctpSubtext1}{HTML}{BAC2DE}
  \definecolor{ctpSubtext0}{HTML}{A6ADC8}
  \definecolor{ctpOverlay2}{HTML}{9399B2}
  \definecolor{ctpOverlay1}{HTML}{7F849C}
  \definecolor{ctpOverlay0}{HTML}{6C7086}
  \definecolor{ctpSurface2}{HTML}{585B70}
  \definecolor{ctpSurface1}{HTML}{45475A}
  \definecolor{ctpSurface0}{HTML}{313244}
  \definecolor{ctpBase}{HTML}{1E1E2E}
  \definecolor{ctpMantle}{HTML}{181825}
  \definecolor{ctpCrust}{HTML}{11111B}
  % Semantic mappings
  \colorlet{ctpChapter}{ctpBlue} % chapter / toc accent
  \colorlet{ctpDefinition}{ctpMauve}
  \colorlet{ctpExample}{ctpTeal}
  \colorlet{ctpTheorem}{ctpMauve}
  \colorlet{ctpRemark}{ctpYellow}
  \colorlet{ctpProof}{ctpRed}
  \colorlet{ctpExplanation}{ctpTeal}
  % Hyperref colors (so they are readable on dark background)
  \hypersetup{
    colorlinks,
    linkcolor=ctpPeach,
    citecolor=ctpGreen,
    urlcolor=ctpSky
  }
\else
  % -------- Latte (light) --------
  \definecolor{ctpRosewater}{HTML}{DC8A78}
  \definecolor{ctpFlamingo}{HTML}{DD7878}
  \definecolor{ctpPink}{HTML}{EA76CB}
  \definecolor{ctpMauve}{HTML}{8839EF}
  \definecolor{ctpRed}{HTML}{D20F39}
  \definecolor{ctpMaroon}{HTML}{E64553}
  \definecolor{ctpPeach}{HTML}{FE640B}
  \definecolor{ctpYellow}{HTML}{DF8E1D}
  \definecolor{ctpGreen}{HTML}{40A02B}
  \definecolor{ctpTeal}{HTML}{179299}
  \definecolor{ctpSky}{HTML}{04A5E5}
  \definecolor{ctpSapphire}{HTML}{209FB5}
  \definecolor{ctpBlue}{HTML}{1E66F5}
  \definecolor{ctpLavender}{HTML}{7287FD}
  \definecolor{ctpText}{HTML}{4C4F69}
  \definecolor{ctpSubtext1}{HTML}{5C5F77}
  \definecolor{ctpSubtext0}{HTML}{6C6F85}
  \definecolor{ctpOverlay2}{HTML}{7C7F93}
  \definecolor{ctpOverlay1}{HTML}{8C8FA1}
  \definecolor{ctpOverlay0}{HTML}{9CA0B0}
  \definecolor{ctpSurface2}{HTML}{ACB0BE}
  \definecolor{ctpSurface1}{HTML}{BCC0CC}
  \definecolor{ctpSurface0}{HTML}{CCD0DA}
  \definecolor{ctpBase}{HTML}{EFF1F5}
  \definecolor{ctpMantle}{HTML}{E6E9EF}
  \definecolor{ctpCrust}{HTML}{DCE0E8}
  % Semantic mappings
  \colorlet{ctpChapter}{ctpLavender}
  \colorlet{ctpDefinition}{ctpMauve}
  \colorlet{ctpExample}{ctpTeal}
  \colorlet{ctpTheorem}{ctpMauve}
  \colorlet{ctpRemark}{ctpYellow}
  \colorlet{ctpProof}{ctpRed}
  \colorlet{ctpExplanation}{ctpTeal}
  % Hyperref colors (darker for light background)
  \hypersetup{
    colorlinks,
    linkcolor=ctpBlue,
    citecolor=ctpGreen,
    urlcolor=ctpTeal
  }
\fi


% tikz
\usepackage{tikz}
\usetikzlibrary{intersections, angles, quotes, calc, positioning}
\usepackage{pgfplots}
\pgfplotsset{compat=1.13}


\tikzset{
    force/.style={thick, {Circle[length=2pt]}-stealth, shorten <=-1pt}
}


%%Commutative diagrams
\usepackage{tikz-cd}
\usetikzlibrary{arrows,arrows.meta}
\makeatletter
\pgfdeclarearrow{
	name=xGlyph,
	cache=false,
	bending mode=none,
	parameters={\tikzcd@glyph@len,\tikzcd@glyph@shorten},
	setup code={%
		\pgfarrowssettipend{\tikzcd@glyph@len\advance\pgf@x by\tikzcd@glyph@shorten}},
	defaults={
		glyph axis=axis_height,
		glyph length=+1.55ex,
		glyph shorten=+-0.1ex},
	drawing code={%
		\pgfpathrectangle{\pgfpoint{+0pt}{+-1.5ex}}{\pgfpoint{+\tikzcd@glyph@len}{+3ex}}%
		\pgfusepathqclip%
		\pgftransformxshift{+\tikzcd@glyph@len}%
		\pgftransformyshift{+-\tikzcd@glyph@axis}%
		\pgftext[right,base]{\tikzcd@glyph}}}
\makeatother
\tikzcdset{
	arrow style=tikz,
	diagrams={>={Latex}},
	tikzcd left hook/.tip={xGlyph[glyph math command=supset, swap, glyph axis = 5.7pt]},
	tikzcd right hook/.tip={xGlyph[glyph math command=supset, glyph axis = 5.7pt]},
	surjective head arrow /.tip = {tikzcd to[sep=-1.5pt]tikzcd to},
	surjective head/.style={
		-surjective head arrow
	}
}

%%Page layout
\usepackage[headsepline]{scrlayer-scrpage}
\renewcommand{\headfont}{}
\addtolength{\textheight}{3.14cm}
\setlength{\footskip}{0.5in}
\setlength{\headsep}{10pt}

\def\shortdate{\leavevmode\hbox{\the\year-\twodigits\month-\twodigits\day}}
\def\twodigits#1{\ifnum#1<10 0\fi\the#1}
\automark[chapter]{chapter}


\rohead{\footnotesize\thepage}
\lehead{\footnotesize\thepage}
\lohead{\footnotesize \leftmark}
\chead{}
\rofoot{}
\refoot{}
\lefoot{}
\lofoot{}
%\cfoot{\pagemark}

%%section and chapter head
\renewcommand*{\sectionformat}{\color{ctpChapter}\thesection\autodot\enskip}
\renewcommand*{\subsectionformat}{\color{ctpChapter}\thesubsection\autodot\enskip}
\renewcommand{\thesubsection}{\thesection.\roman{subsection}}

\addtokomafont{chapterprefix}{\raggedleft}
\RedeclareSectionCommand[beforeskip=0.5em]{chapter}
\renewcommand*{\chapterformat}{%
\mbox{\scalebox{1.5}{\chapappifchapterprefix{\nobreakspace}}%
\scalebox{2.718}{\color{ctpChapter}\thechapter\autodot}\enskip}}

\addtokomafont{partprefix}{\rmfamily}
\renewcommand*{\partformat}{\color{ctpChapter}\scalebox{2.5}{\thepart}}

%%Theorems
\usepackage{tcolorbox}
\tcbuselibrary{breakable,skins,hooks}

% patch tcolorbox to support continuation of a paragraph
% after box
\makeatletter
\tcbset{
	after app={%
		\ifx\tcb@drawcolorbox\tcb@drawcolorbox@breakable
		\else
		% add only when not breakabel
		\@endparenv
		\fi
	}
}

% for breakable
\appto\tcb@use@after@lastbox{\@endparenv\@doendpe}
\makeatother
% END patch tcolorbox for continuation of paragraph


% theorems
\makeatother
\usepackage{thmtools}
\usepackage[framemethod=TikZ]{mdframed}
\mdfsetup{skipabove=1em,skipbelow=0em}


\theoremstyle{definition}


\declaretheoremstyle[
    headfont=\bfseries\sffamily\color{ctpMauve},
    bodyfont=\normalfont,
    mdframed={
        linewidth=2pt,
        rightline=false, topline=false, bottomline=false,
        linecolor=ctpMauve,
        backgroundcolor=ctpMauve!8,
    }
]{thmgreenbox} % definitions

\declaretheoremstyle[
    headfont=\bfseries\sffamily\color{ctpTeal},
    bodyfont=\normalfont,
    mdframed={
        linewidth=2pt,
        rightline=false, topline=false, bottomline=false,
        linecolor=ctpTeal,
        backgroundcolor=ctpTeal!8,
    }
]{thmbluebox} % examples

\declaretheoremstyle[
    headfont=\bfseries\sffamily\color{ctpYellow},
    bodyfont=\normalfont,
    mdframed={
        linewidth=2pt,
        rightline=false, topline=false, bottomline=false,
        linecolor=ctpYellow
    }
]{thmblueline} % remarks / notes (line only)

\declaretheoremstyle[
    headfont=\bfseries\sffamily\color{ctpMauve},
    bodyfont=\normalfont,
    mdframed={
        linewidth=2pt,
        rightline=false, topline=false, bottomline=false,
        linecolor=ctpMauve,
        backgroundcolor=ctpMauve!10,
    }
]{thmredbox} % theorem / lemma / proposition / corollary

\declaretheoremstyle[
    headfont=\bfseries\sffamily\color{ctpMauve},
    bodyfont=\normalfont,
    numbered=no,
    mdframed={
        linewidth=2pt,
        rightline=false, topline=false, bottomline=false,
        linecolor=ctpMauve,
        backgroundcolor=ctpMauve!1,
    },
    qed=\qedsymbol
]{thmproofbox}

\declaretheoremstyle[
    headfont=\bfseries\sffamily\color{ctpTeal},
    bodyfont=\normalfont,
    numbered=no,
    mdframed={
        linewidth=2pt,
        rightline=false, topline=false, bottomline=false,
        linecolor=ctpTeal,
        backgroundcolor=ctpTeal!1,
    },
]{thmexplanationbox} % explanations


\declaretheorem[style=thmgreenbox, name=definition]{definition}
\declaretheorem[style=thmbluebox, numbered=no, name=example]{eg}
\declaretheorem[style=thmredbox, name=proposition]{prop}
\declaretheorem[style=thmredbox, name=theorem]{theorem}
\declaretheorem[style=thmredbox, name=lemma]{lemma}
\declaretheorem[style=thmredbox, numbered=no, name=corollary]{corollary}

\declaretheorem[style=thmproofbox, name=proof]{replacementproof}
\renewenvironment{proof}[1][\proofname]{\vspace{-12pt}\begin{replacementproof}}{\end{replacementproof}}


\declaretheorem[style=thmexplanationbox, name=proof]{tmpexplanation}
\newenvironment{explanation}[1][]{\vspace{-12pt}\begin{tmpexplanation}}{\end{tmpexplanation}}

\declaretheorem[style=thmblueline, numbered=no, name=Remark]{remark}
\declaretheorem[style=thmblueline, numbered=no, name=Note]{note}

\newtheorem*{uovt}{UOVT}
\newtheorem*{notation}{Notation}
\newtheorem*{previouslyseen}{As previously seen}
\newtheorem*{problem}{Problem}
\newtheorem*{observe}{Observe}
\newtheorem*{property}{Property}
\newtheorem*{intuition}{Intuition}


\usepackage{etoolbox}
\AtEndEnvironment{vb}{\null\hfill$\diamond$}%
\AtEndEnvironment{intermezzo}{\null\hfill$\diamond$}%
\makeatletter


\usepackage{xifthen}

\def\testdateparts#1{\dateparts#1\relax}
\def\dateparts#1 #2 #3 #4 #5\relax{
    \marginpar{\small\textsf{\mbox{#1 #2 #3 #5}}}
}



%%Table of contents
% First add ToC to ToC
\makeatletter
\usepackage{etoolbox}
\pretocmd{\tableofcontents}{%
	\if@openright\cleardoublepage\else\clearpage\fi
	\pdfbookmark[0]{\contentsname}{toc}%
}{}{}%
\makeatother
\setcounter{tocdepth}{1}
\RedeclareSectionCommand[tocnumwidth=4.2em]{part}
\RedeclareSectionCommand[tocpagenumberwidth=2.2em,tocnumwidth=4.2em]{chapter}
\RedeclareSectionCommand[tocpagenumberwidth=2.2em,tocnumwidth=2.8em]{section}


%%Mini ToC
\usepackage[tight]{minitoc}
\mtcsetfont{parttoc}{chapter}{\sffamily\bfseries}
\mtcsetfont{parttoc}{section}{\footnotesize\rmfamily\upshape\mdseries}
\mtcsetfont{parttoc}{subsection}{\footnotesize\rmfamily\upshape\mdseries}
%\mtcsetdepth{parttoc}{1}
\setcounter{parttocdepth}{1}
\renewcommand*{\partheadstartvskip}{\vspace*{20em}}
\renewcommand*{\partheadendvskip}{}
%\noptcrule
\renewcommand\beforeparttoc{\noindent{\bfseries \Large Part \thepart: Contents}}
%\hspace{\fill}\rule{0.95\linewidth}{2pt}\hspace{\fill}
\doparttoc[n]

%%Bibliography
\usepackage[backend=biber,backref=true,style=alphabetic]{biblatex}
\DeclareLabelalphaTemplate{
	\labelelement{
		\field[final]{shorthand}
		\field{label}
		\field[strwidth=2,strside=left]{labelname}
	}
	\labelelement{
		\field[strwidth=2,strside=right]{year}
	}
}
\DeclareFieldFormat{labelalpha}{\textbf{\scriptsize #1}}
\addbibresource{references.bib}
\addbibresource{images.bib}
%% stylistic biblatex choices
\DefineBibliographyStrings{english}{%
	backrefpage  = {cited p.}, % for single page number
	backrefpages = {cited pp.} % for multiple page numbers
}
\DeclareFieldFormat{journaltitle}{\mkbibemph{#1},} % italic journal title with comma
\DeclareFieldFormat[inbook,thesis]{title}{\mkbibemph{#1}\addperiod} % italic title with period
\DeclareFieldFormat[article]{title}{#1} % title of journal article is printed as normal text
\DeclareFieldFormat[article]{volume}{\textbf{#1}\addcolon\space}
\renewcommand{\mkbibnamegiven}[1]{\textsc{#1}}
\renewcommand{\mkbibnamefamily}[1]{\textsc{#1}}
\renewcommand{\mkbibnameprefix}[1]{\textsc{#1}}
\renewcommand{\mkbibnamesuffix}[1]{\textsc{#1}}
\renewcommand{\finentrypunct}{}

%% Misc haxx
\pdfstringdefDisableCommands{\def\Spec{\text{Spec }}\def\sigma{σ}}